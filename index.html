<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BU-Buddy | QG du Groupe</title>
    
    <!-- PWA / Mode Application Mobile -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BU-Buddy">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4f46e5">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: contain; }
        .tab-active { color: #4f46e5; border-bottom: 3px solid #4f46e5; }
        .prose h1 { font-size: 1.25rem; font-weight: 800; margin-bottom: 0.5rem; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen flex flex-col select-none">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50 pt-[env(safe-area-inset-top)]">
        <div class="max-w-2xl mx-auto px-5 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-indigo-600 p-2 rounded-xl text-white shadow-lg">
                    <i data-lucide="zap" class="w-5 h-5 fill-current"></i>
                </div>
                <h1 class="text-lg font-extrabold tracking-tight italic">BU-BUDDY</h1>
            </div>
            <div id="sync-status" class="flex items-center gap-1.5 px-3 py-1.5 bg-slate-100 rounded-full">
                <div class="w-1.5 h-1.5 bg-red-400 rounded-full" id="status-dot"></div>
                <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest" id="status-text">Hors-ligne</span>
            </div>
        </div>
    </header>

    <!-- √âcran d'erreur si Firebase n'est pas configur√© -->
    <div id="error-screen" class="hidden flex-1 flex flex-col items-center justify-center p-8 text-center space-y-6">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl border border-red-100 max-w-sm">
            <div class="bg-red-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="database" class="w-8 h-8 text-red-500"></i>
            </div>
            <h2 class="text-xl font-black text-slate-800 mb-2">Moteur manquant !</h2>
            <p class="text-sm text-slate-500 leading-relaxed mb-6">
                L'application est sur GitHub, mais elle n'est pas reli√©e √† une base de donn√©es. Les boutons ne peuvent pas fonctionner sans √ßa.
            </p>
            <div class="text-left bg-slate-50 p-4 rounded-2xl text-[10px] font-mono text-slate-600 overflow-x-auto mb-6">
                1. Va sur console.firebase.google.com<br>
                2. Cr√©e un projet Web<br>
                3. Colle tes cl√©s √† la ligne 125 du code
            </div>
            <a href="https://console.firebase.google.com" target="_blank" class="block w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold text-sm shadow-lg shadow-indigo-100 uppercase">
                Ouvrir Firebase
            </a>
        </div>
    </div>

    <!-- Interface Application -->
    <main id="app-main" class="flex-1 max-w-2xl mx-auto w-full p-4 pb-32">
        <nav class="flex border-b border-slate-200 mb-6 sticky top-[73px] bg-slate-50/90 backdrop-blur-sm z-40 px-2">
            <button onclick="window.setTab('plan', this)" class="nav-btn flex-1 py-3 text-[10px] font-black uppercase tracking-widest tab-active">Planning</button>
            <button onclick="window.setTab('docs', this)" class="nav-btn flex-1 py-3 text-[10px] font-black uppercase tracking-widest text-slate-400">Cours</button>
            <button onclick="window.setTab('notes', this)" class="nav-btn flex-1 py-3 text-[10px] font-black uppercase tracking-widest text-slate-400">Notes</button>
        </nav>

        <!-- Planning -->
        <div id="view-plan" class="view space-y-4">
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 space-y-3">
                <input type="text" id="ev-title" placeholder="Mati√®re..." class="w-full p-4 bg-slate-50 rounded-2xl text-sm border-none outline-none ring-indigo-500 focus:ring-2">
                <div class="flex gap-2">
                    <input type="date" id="ev-date" class="flex-1 p-4 bg-slate-50 rounded-2xl text-sm border-none">
                    <input type="time" id="ev-time" class="w-24 p-4 bg-slate-50 rounded-2xl text-sm border-none">
                </div>
                <button onclick="window.addSession()" class="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold text-sm shadow-lg active:scale-95 transition-all">AJOUTER</button>
            </div>
            <div id="events-list" class="space-y-3"></div>
        </div>

        <!-- Documents -->
        <div id="view-docs" class="view hidden space-y-4">
            <div class="bg-white p-5 rounded-3xl border border-slate-100 space-y-3">
                <input type="text" id="doc-name" placeholder="Titre du cours" class="w-full p-4 bg-slate-50 rounded-2xl text-sm border-none outline-none">
                <input type="text" id="doc-url" placeholder="Lien Drive/PDF" class="w-full p-4 bg-slate-50 rounded-2xl text-sm border-none outline-none">
                <button onclick="window.addDocument()" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-bold text-sm">PARTAGER</button>
            </div>
            <div id="docs-list" class="grid gap-3"></div>
        </div>

        <!-- Notes -->
        <div id="view-notes" class="view hidden space-y-4">
            <button onclick="window.newNote()" class="w-full p-6 bg-white border-2 border-dashed border-indigo-200 rounded-[2rem] text-indigo-600 font-extrabold flex items-center justify-center gap-2 active:bg-indigo-50 transition-colors">
                NOUVELLE FICHE
            </button>
            <div id="notes-grid" class="grid gap-3"></div>
        </div>
    </main>

    <!-- √âditeur Modal -->
    <div id="editor-modal" class="hidden fixed inset-0 bg-white z-[100] flex flex-col pt-10">
        <div class="p-4 border-b flex justify-between items-center bg-slate-50">
            <button onclick="window.closeEditor()" class="text-[10px] font-black text-slate-400 p-2">RETOUR</button>
            <div class="flex bg-slate-200 p-1 rounded-xl">
                <button onclick="window.viewMd(false)" id="btn-edit" class="px-4 py-1.5 text-[9px] font-bold rounded-lg bg-white shadow-sm uppercase tracking-tighter">√âditer</button>
                <button onclick="window.viewMd(true)" id="btn-preview" class="px-4 py-1.5 text-[9px] font-bold rounded-lg text-slate-500 uppercase tracking-tighter">Aper√ßu</button>
            </div>
        </div>
        <input type="text" id="nt-title" placeholder="Titre..." class="p-6 text-xl font-bold border-none outline-none">
        <textarea id="nt-body" class="flex-1 p-6 text-sm outline-none resize-none font-medium leading-relaxed" placeholder="Markdown..."></textarea>
        <div id="nt-preview" class="hidden flex-1 p-6 overflow-y-auto prose max-w-none"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // ======================================================
        // üîë CONFIGURATION FIREBASE (REMPLACE ICI POUR GITHUB)
        // ======================================================
        let config = null;
        try { config = JSON.parse(__firebase_config); } catch(e) {
            config = {
                apiKey: "REMPLACE_PAR_TA_CLE",
                authDomain: "TON_PROJET.firebaseapp.com",
                projectId: "TON_PROJET",
                storageBucket: "TON_PROJET.appspot.com",
                messagingSenderId: "TON_ID",
                appId: "TON_APP_ID"
            };
        }

        // V√©rification si config remplie
        if (!config || !config.apiKey || config.apiKey === "REMPLACE_PAR_TA_CLE") {
            document.getElementById('error-screen').classList.remove('hidden');
            document.getElementById('app-main').classList.add('hidden');
            lucide.createIcons();
        } else {
            const app = initializeApp(config);
            const db = getFirestore(app);
            const auth = getAuth(app);
            const gid = typeof __app_id !== 'undefined' ? __app_id : 'bu-buddy-final';

            // Auth Rule 3
            const login = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            };

            onAuthStateChanged(auth, u => {
                if(u) {
                    document.getElementById('status-dot').className = "w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse";
                    document.getElementById('status-text').innerText = "Synchro Live";
                    startSync(db, gid);
                }
            });
            login();

            // Handlers
            window.addSession = async () => {
                if (!auth.currentUser) return;
                const t = document.getElementById('ev-title').value;
                const d = document.getElementById('ev-date').value;
                const h = document.getElementById('ev-time').value;
                if(t && d) await addDoc(collection(db, 'artifacts', gid, 'public', 'data', 'planning'), {t, d, h});
                document.getElementById('ev-title').value = "";
            };

            window.addDocument = async () => {
                if (!auth.currentUser) return;
                const n = document.getElementById('doc-name').value;
                const u = document.getElementById('doc-url').value;
                if(n && u) await addDoc(collection(db, 'artifacts', gid, 'public', 'data', 'docs'), {n, u});
                document.getElementById('doc-name').value = ""; document.getElementById('doc-url').value = "";
            };

            window.newNote = async () => {
                if (!auth.currentUser) return;
                const r = await addDoc(collection(db, 'artifacts', gid, 'public', 'data', 'notes'), {title: "", content: ""});
                window.openNote(r.id);
            };

            let curId = null;
            window.openNote = (id) => {
                curId = id;
                document.getElementById('editor-modal').classList.remove('hidden');
                onSnapshot(doc(db, 'artifacts', gid, 'public', 'data', 'notes', id), d => {
                    if(d.exists() && curId === id) {
                        const val = d.data();
                        if(document.activeElement !== document.getElementById('nt-title')) document.getElementById('nt-title').value = val.title || "";
                        if(document.activeElement !== document.getElementById('nt-body')) {
                            document.getElementById('nt-body').value = val.content || "";
                            document.getElementById('nt-preview').innerHTML = marked.parse(val.content || "");
                        }
                    }
                });
            };

            window.closeNote = () => { curId = null; document.getElementById('editor-modal').classList.add('hidden'); };
            window.del = async (c, i) => { if(confirm("Supprimer ?")) await deleteDoc(doc(db, 'artifacts', gid, 'public', 'data', c, i)); };

            const save = () => {
                if(!curId || !auth.currentUser) return;
                setDoc(doc(db, 'artifacts', gid, 'public', 'data', 'notes', curId), {
                    title: document.getElementById('nt-title').value,
                    content: document.getElementById('nt-body').value
                }, {merge: true});
            };
            document.getElementById('nt-title').oninput = save;
            document.getElementById('nt-body').oninput = e => { save(); document.getElementById('nt-preview').innerHTML = marked.parse(e.target.value); };

            function startSync(db, gid) {
                // Rule 1 paths
                onSnapshot(collection(db, 'artifacts', gid, 'public', 'data', 'planning'), s => {
                    const l = document.getElementById('events-list'); l.innerHTML = "";
                    s.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>(a.d+a.h).localeCompare(b.d+b.h)).forEach(ev => {
                        const d = document.createElement('div');
                        d.className = "bg-white p-4 rounded-2xl flex justify-between items-center border border-slate-100 shadow-sm";
                        d.innerHTML = `<div class="flex gap-4 items-center">
                            <div class="bg-indigo-50 text-indigo-700 w-10 h-10 rounded-xl flex flex-col items-center justify-center font-black text-[10px]">
                                <span>${new Date(ev.d).getDate()}</span>
                            </div>
                            <div><div class="font-bold text-xs uppercase tracking-tight">${ev.t}</div><div class="text-[9px] text-slate-400 font-bold">${ev.h} ‚Ä¢ BU</div></div>
                        </div><button onclick="window.del('planning', '${ev.id}')" class="text-slate-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                        l.appendChild(d);
                    });
                    lucide.createIcons();
                });

                onSnapshot(collection(db, 'artifacts', gid, 'public', 'data', 'docs'), s => {
                    const l = document.getElementById('docs-list'); l.innerHTML = "";
                    s.docs.forEach(d => {
                        const lk = d.data();
                        const div = document.createElement('div');
                        div.className = "bg-white p-4 rounded-2xl border flex justify-between items-center shadow-sm";
                        div.innerHTML = `<div class="truncate flex-1 mr-4"><div class="font-bold text-xs uppercase truncate leading-tight">${lk.n}</div>
                        <a href="${lk.u}" target="_blank" class="text-indigo-600 text-[9px] font-black underline italic">Ouvrir le doc</a></div>
                        <button onclick="window.del('docs', '${d.id}')" class="text-slate-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                        l.appendChild(div);
                    });
                    lucide.createIcons();
                });

                onSnapshot(collection(db, 'artifacts', gid, 'public', 'data', 'notes'), s => {
                    const g = document.getElementById('notes-grid'); g.innerHTML = "";
                    s.docs.forEach(d => {
                        const div = document.createElement('div');
                        div.className = "bg-white p-4 rounded-2xl border flex justify-between items-center shadow-sm active:bg-slate-50";
                        div.innerHTML = `<div onclick="window.openNote('${d.id}')" class="flex-1 font-bold text-sm cursor-pointer uppercase tracking-tighter truncate pr-4">${d.data().title || "Note sans titre"}</div>
                        <button onclick="window.del('notes', '${d.id}')" class="text-slate-200 ml-4"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                        g.appendChild(div);
                    });
                    lucide.createIcons();
                });
            }
        }
    </script>

    <script>
        window.setTab = (id, btn) => {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById('view-' + id).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('tab-active', 'text-indigo-600'));
            btn.classList.add('tab-active', 'text-indigo-600');
            lucide.createIcons();
        };
        window.viewMd = (show) => {
            document.getElementById('nt-body').classList.toggle('hidden', show);
            document.getElementById('nt-preview').classList.toggle('hidden', !show);
            document.getElementById('btn-edit').className = show ? "px-4 py-1.5 text-[9px] font-bold rounded-lg text-slate-500 uppercase tracking-tighter" : "px-4 py-1.5 text-[9px] font-bold rounded-lg bg-white shadow-sm uppercase tracking-tighter";
            document.getElementById('btn-preview').className = !show ? "px-4 py-1.5 text-[9px] font-bold rounded-lg text-slate-500 uppercase tracking-tighter" : "px-4 py-1.5 text-[9px] font-bold rounded-lg bg-white shadow-sm uppercase tracking-tighter";
        };
        window.onload = () => lucide.createIcons();
    </script>
</body>
</html>
